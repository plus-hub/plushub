name: Sync Public Repo to Private Repo

on:
  push:
    branches:
      - main
    paths:
      - 'docs/**/*.md'
      - 'docs/public/assets/**'
      - 'README.md'
      - 'CONTRIBUTING.md'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout public repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Verify secret exists
        run: |
          if [ -z "${{ secrets.PRIVATE_REPO_TOKEN }}" ]; then
            echo "❌ Error: PRIVATE_REPO_TOKEN secret is not set!"
            exit 1
          else
            echo "✅ Secret found (length: ${#PRIVATE_REPO_TOKEN})"
            echo "Token starts with: ${PRIVATE_REPO_TOKEN:0:7}..."
            echo "Testing token with GitHub API..."
            API_RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.PRIVATE_REPO_TOKEN }}" https://api.github.com/repos/plus-hub/plushub-private 2>&1)
            if echo "$API_RESPONSE" | grep -q '"name": "plushub-private"'; then
              echo "✅ Token can access private repo via API"
            else
              echo "❌ Token cannot access private repo via API"
              echo "API Response: $API_RESPONSE"
              exit 1
            fi
          fi
        env:
          PRIVATE_REPO_TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}

      - name: Configure Git Credential Helper
        run: |
          git config --global --unset-all credential.helper || true
          git config --local --unset-all http.https://github.com/.extraheader || true
          echo "✅ Using explicit token in URLs (no credential helper)"

      - name: Add private repo as remote
        run: |
          git remote add private https://x-access-token:${{ secrets.PRIVATE_REPO_TOKEN }}@github.com/plus-hub/plushub-private.git \
            || git remote set-url private https://x-access-token:${{ secrets.PRIVATE_REPO_TOKEN }}@github.com/plus-hub/plushub-private.git
          git remote -v

      - name: Fetch from private repo
        run: |
          GIT_TERMINAL_PROMPT=0 git fetch https://x-access-token:${{ secrets.PRIVATE_REPO_TOKEN }}@github.com/plus-hub/plushub-private.git main \
            || echo "⚠️  Private repo fetch failed - might be first sync or empty repo"

      - name: Update only docs in private repo
        run: |
          set -e
          # Base on private/main to preserve everything
          if git ls-remote --heads https://x-access-token:${{ secrets.PRIVATE_REPO_TOKEN }}@github.com/plus-hub/plushub-private.git main | grep -q main; then
            git checkout -B sync-branch FETCH_HEAD
          else
            git checkout --orphan sync-branch
            rm -rf ./* 2>/dev/null || true
            git reset
          fi

          # Enumerate and copy only allowed files from public
          git ls-tree -r --name-only origin/main | \
            grep -E '^(README\.md|CONTRIBUTING\.md|docs/.*\.md|docs/public/assets/)' | \
            while read -r path; do
              mkdir -p "$(dirname "$path")"
              git show origin/main:"$path" > "$path" 2>/dev/null || echo "⚠️  Could not copy: $path"
            done

          # Deletions: remove docs/*.md and docs/public/assets files that no longer exist in public
          # (Never touch other files like docs/.vitepress or application code)
          for f in $(git ls-tree -r --name-only HEAD | grep -E '^docs/.*\.md$' || true); do
            if ! git cat-file -e origin/main:"$f" 2>/dev/null; then
              git rm -f "$f" || true
            fi
          done

          # Handle deletions in docs/public/assets/ (images, etc.)
          for f in $(git ls-tree -r --name-only HEAD | grep -E '^docs/public/assets/' || true); do
            if ! git cat-file -e origin/main:"$f" 2>/dev/null; then
              git rm -f "$f" || true
            fi
          done
          
          # Also handle image files directly in docs/ if any (though they should be in public/assets/)
          for f in $(git ls-tree -r --name-only HEAD | grep -E '^docs/.*\.(png|jpg|jpeg|gif|svg|webp|ico)$' || true); do
            if ! git cat-file -e origin/main:"$f" 2>/dev/null; then
              git rm -f "$f" || true
            fi
          done

          # Optional: also reflect deletion of README.md / CONTRIBUTING.md if removed in public
          for f in README.md CONTRIBUTING.md; do
            if git ls-files --error-unmatch "$f" >/dev/null 2>&1; then
              if ! git cat-file -e origin/main:"$f" 2>/dev/null; then
                git rm -f "$f" || true
              fi
            fi
          done

          # Stage only those paths
          git add README.md 2>/dev/null || true
          git add CONTRIBUTING.md 2>/dev/null || true
          git add docs 2>/dev/null || true

          echo "Files staged:"
          git diff --cached --name-only || true

          if ! git diff --cached --quiet; then
            git commit -m "Sync: Update docs from public repo"
          else
            echo "No changes to commit"
          fi

      - name: Push to private repo
        run: |
          echo "Pushing to private repo..."
          GIT_TERMINAL_PROMPT=0 git push https://x-access-token:${{ secrets.PRIVATE_REPO_TOKEN }}@github.com/plus-hub/plushub-private.git sync-branch:main
        env:
          GIT_TERMINAL_PROMPT: 0

      - name: Cleanup
        run: |
          git checkout main
          git branch -D sync-branch
